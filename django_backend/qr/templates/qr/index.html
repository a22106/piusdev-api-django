{# index.html #}
{% extends 'base.html' %}
{% load static %}

{% block title %}{{ site_title }}{% endblock %}
{% block description %}{{ site_description }}{% endblock %}
{% block keywords %}{{ site_keywords }}{% endblock %}

{% block content %}

    <div class="container-fluid">
        <div class="row">
            <!-- QR Form Column -->
            <div class="col-lg-9">
                <div class="card p-4">
                    <div class="mb-3">
                        <label class="form-label d-block">Select QR Code Type:</label>
                        <div class="row row-cols-lg-5 row-cols-md-4 row-cols-sm-3 row-cols-2 g-2" role="group" aria-label="QR Code Type">
                            <div class="col">
                                <input type="radio" class="btn-check" name="qr_type" id="typeUrl" value="url" autocomplete="off" checked>
                                <label class="btn btn-outline-primary w-100" for="typeUrl">URL</label>
                            </div>

                            <div class="col">
                                <input type="radio" class="btn-check" name="qr_type" id="typeEmail" value="email" autocomplete="off">
                                <label class="btn btn-outline-primary w-100" for="typeEmail">Email</label>
                            </div>

                            <div class="col">
                                <input type="radio" class="btn-check" name="qr_type" id="typeText" value="text" autocomplete="off">
                                <label class="btn btn-outline-primary w-100" for="typeText">Text</label>
                            </div>

                            <div class="col">
                                <input type="radio" class="btn-check" name="qr_type" id="typePhone" value="phone" autocomplete="off">
                                <label class="btn btn-outline-primary w-100" for="typePhone">Phone</label>
                            </div>

                            <div class="col">
                                <input type="radio" class="btn-check" name="qr_type" id="typeVcard" value="vcard" autocomplete="off">
                                <label class="btn btn-outline-primary w-100" for="typeVcard">V Card</label>
                            </div>

                            <div class="col">
                                <input type="radio" class="btn-check" name="qr_type" id="typeWifi" value="wifi" autocomplete="off">
                                <label class="btn btn-outline-primary w-100" for="typeWifi">WiFi</label>
                            </div>

                            <div class="col">
                                <input type="radio" class="btn-check" name="qr_type" id="typeSms" value="sms" autocomplete="off">
                                <label class="btn btn-outline-primary w-100" for="typeSms">SMS</label>
                            </div>

                            <div class="col">
                                <input type="radio" class="btn-check" name="qr_type" id="typeGeo" value="geo" autocomplete="off">
                                <label class="btn btn-outline-primary w-100" for="typeGeo">Geolocation</label>
                            </div>

{#                            <div class="col">#}
{#                                <input type="radio" class="btn-check" name="qr_type" id="typeEvent" value="event" autocomplete="off">#}
{#                                <label class="btn btn-outline-primary w-100" for="typeEvent">Event</label>#}
{#                            </div>#}
{#                    #}
{#                            <div class="col">#}
{#                                <input type="radio" class="btn-check" name="qr_type" id="typeMeCard" value="mecard" autocomplete="off">#}
{#                                <label class="btn btn-outline-primary w-100" for="typeMeCard">MeCard</label>#}
{#                            </div>#}

                            <div class="col">
                                <input type="radio" class="btn-check" name="qr_type" id="typeWhatsApp" value="whatsapp" autocomplete="off">
                                <label class="btn btn-outline-primary w-100" for="typeWhatsApp">WhatsApp</label>
                            </div>

{#                            <div class="col">#}
{#                                <input type="radio" class="btn-check" name="qr_type" id="typeBitcoin" value="bitcoin" autocomplete="off">#}
{#                                <label class="btn btn-outline-primary w-100" for="typeBitcoin">Bitcoin</label>#}
{#                            </div>#}
                        </div>
                    </div>

                    <h1>QR Code Generator</h1>
                    <p class="text-muted">
                        <span class="text-danger">*</span> Required fields
                    </p>
                    <form action="{% url 'qr:index' %}" method="post" id="qr-form">
                        {% csrf_token %}
                        <!-- URL Input Section -->
                        <div id="input-url" class="input-section" style="display: none;">
                            <label class="form-label mb-3 w-100">
                                <span class="text-danger">*</span> URL:
                                <input type="text" name="url" placeholder="https://example.com" class="form-control w-100">
                            </label>
                        </div>

                        <!-- Email Input Section -->
                        <div id="input-email" class="input-section" style="display: none;">
                            <label class="form-label mb-3 w-100">
                                <span class="text-danger">*</span> Email: <input type="email" name="email" placeholder="example@example.com" class="form-control w-100">
                            </label><br>
                            <label class="form-label mb-3 w-100">
                                Subject: <input type="text" name="subject" placeholder="Enter Subject" class="form-control w-100">
                            </label><br>
                            <label class="form-label mb-3 w-100">
                                Body: <textarea name="body" placeholder="Enter Body" class="form-control w-100" rows="4"></textarea>
                            </label>
                        </div>

                        <!-- Text Input Section -->
                        <div id="input-text" class="input-section" style="display: none;">
                            <label class="form-label mb-3 w-100">
                                <span class="text-danger">*</span>Text: <textarea type="text" name="text" placeholder="Enter Text" class="form-control w-100" rows="4"></textarea>
                            </label>
                            <div class="form-check mb-3">
                                <input class="form-check-input" type="checkbox" name="rounded" id="roundedCorners">
                                <label class="form-check-label" for="roundedCorners">
                                    Use rounded corners
                                </label>
                            </div>
                        </div>

                        <!-- Phone Number Input Section -->
                        <div id="input-phone" class="input-section" style="display: none;">
                            {% include 'qr/input_phone.html' %}
                        </div>

                        <!-- VCard Input Section -->
                        <div id="input-vcard" class="input-section" style="display: none;">
                            <div class="row">
                                <div class="col-md-6 mb-3">
                                    <label class="form-label w-100">
                                        <span class="text-danger">*</span> First Name:
                                        <input type="text" name="first_name" placeholder="First Name" class="form-control" style="border-top-right-radius: 0; border-bottom-right-radius: 0;">
                                    </label>
                                </div>
                                <div class="col-md-6 mb-3">
                                    <label class="form-label w-100">
                                        <span class="text-danger">*</span> Last Name:
                                        <input type="text" name="last_name" placeholder="Last Name" class="form-control" style="border-top-left-radius: 0; border-bottom-left-radius: 0;">
                                    </label>
                                </div>
                            </div>
                            <div class="row">
                                <div class="col-md-6 mb-3">
                                    <label class="form-label w-100">
                                        <span class="text-danger">*</span> Email:
                                        <input type="email" name="vcard_email" placeholder="Email" class="form-control" style="border-top-right-radius: 0; border-bottom-right-radius: 0;">
                                    </label>
                                </div>
                                <div class="col-md-6 mb-3">
                                    <label class="form-label w-100">
                                        <span class="text-danger">*</span> Phone (Mobile):
                                        <input type="text" name="vcard_mobile" placeholder="Mobile Phone" class="form-control" style="border-top-left-radius: 0; border-bottom-left-radius: 0;">
                                    </label>
                                </div>
                            </div>
                            <div class="row">
                                <div class="col-md-6 mb-3">
                                    <label class="form-label w-100">
                                        Organization:
                                        <input type="text" name="organization" placeholder="Organization" class="form-control" style="border-top-right-radius: 0; border-bottom-right-radius: 0;">
                                    </label>
                                </div>
                                <div class="col-md-6 mb-3">
                                    <label class="form-label w-100">
                                        Job Title:
                                        <input type="text" name="job_title" placeholder="Title" class="form-control" style="border-top-left-radius: 0; border-bottom-left-radius: 0;">
                                    </label>
                                </div>
                            </div>
                            <label class="form-label mb-3 w-100">
                                Address: <textarea type="text" name="address" placeholder="Address" class="form-control w-100" rows="2"></textarea>
                            </label><br>
                            <label class="form-label mb-3 w-100">
                                URL: <input type="url" name="vcard_url" placeholder="https://example.com" class="form-control">
                            </label><br>
                            <label class="form-label mb-3 w-100">
                                Note: <textarea name="note" placeholder="Note" class="form-control w-100" rows="4"></textarea>
                            </label>
                        </div>

                        <!-- WiFi Input Section -->
                        <div id="input-wifi" class="input-section" style="display: none;">
                            <label class="form-label mb-3">
                                <span class="text-danger">*</span> Network name: <input type="text" name="ssid" placeholder="WiFi SSID" class="form-control">
                            </label>
                            <label class="form-label mb-3">
                                Password: <input type="password" name="password" placeholder="WiFi Password" class="form-control">
                            </label>
                            <label class="form-label">
                                Encryption Type:
                                <select name="encryption" class="form-select">
                                    <option value="WPA">WPA</option>
                                    <option value="WEP">WEP</option>
                                    <option value="nopass">None</option>
                                </select>
                            </label>
                        </div>

                        <!-- SMS Input Section -->
                        <div id="input-sms" class="input-section" style="display: none;">
                            {% include 'qr/input_phone.html' %}
                            <label class="form-label mb-3 w-100">
                                Message (Optional): <textarea name="message" placeholder="Message" class="form-control w-100" rows="4"></textarea>
                            </label>
                        </div>

                        <!-- Geolocation Input Section -->
                        <div id="input-geo" class="input-section" style="display: none;">
                            <label class="form-label mb-3 w-100">
                                <span class="text-danger">*</span> Latitude: <input type="text" name="latitude" placeholder="Enter Latitude" class="form-control w-100" required>
                            </label>
                            <label class="form-label mb-3 w-100">
                                <span class="text-danger">*</span> Longitude: <input type="text" name="longitude" placeholder="Enter Longitude" class="form-control w-100" required>
                            </label>
                            <label class="form-label mb-3 w-100">
                                Query (Optional): <input type="text" name="query" placeholder="Enter Query" class="form-control w-100">
                            </label>
                            <label class="form-label mb-3 w-100">
                                Zoom Level (Optional): <input type="number" name="zoom" placeholder="Enter Zoom Level" class="form-control w-100">
                            </label>
                        </div>

                        <!-- Event Input Section -->
                        <div id="input-event" class="input-section" style="display: none;">
                            <label class="form-label mb-3 w-100">
                                <span class="text-danger">*</span> Summary: <input type="text" name="summary" placeholder="Event Summary" class="form-control w-100" required>
                            </label>
                            <label class="form-label mb-3 w-100">
                                <span class="text-danger">*</span> Start Date (YYYYMMDDTHHMMSSZ): <input type="text" name="start_date" placeholder="Start Date" class="form-control w-100" required>
                            </label>
                            <label class="form-label mb-3 w-100">
                                <span class="text-danger">*</span> End Date (YYYYMMDDTHHMMSSZ): <input type="text" name="end_date" placeholder="End Date" class="form-control w-100" required>
                            </label>
                            <label class="form-label mb-3 w-100">
                                Location: <input type="text" name="location" placeholder="Event Location" class="form-control w-100">
                            </label>
                            <label class="form-label mb-3 w-100">
                                Description: <textarea name="description" placeholder="Event Description" class="form-control w-100" rows="4"></textarea>
                            </label>
                        </div>

                        <!-- MeCard Input Section -->
                        <div id="input-mecard" class="input-section" style="display: none;">
                            <label class="form-label mb-3 w-100">
                                <span class="text-danger">*</span> Name: <input type="text" name="name" placeholder="Name" class="form-control w-100" required>
                            </label>
                            <label class="form-label mb-3 w-100">
                                Phonetic Reading: <input type="text" name="reading" placeholder="Phonetic Reading" class="form-control w-100">
                            </label>
                            <label class="form-label mb-3 w-100">
                                Telephone: <input type="text" name="tel" placeholder="Telephone" class="form-control w-100">
                            </label>
                            <label class="form-label mb-3 w-100">
                                Email: <input type="email" name="email" placeholder="Email" class="form-control w-100">
                            </label>
                            <label class="form-label mb-3 w-100">
                                Memo: <input type="text" name="memo" placeholder="Memo" class="form-control w-100">
                            </label>
                            <label class="form-label mb-3 w-100">
                                Birthday (YYYYMMDD): <input type="text" name="birthday" placeholder="Birthday" class="form-control w-100">
                            </label>
                            <label class="form-label mb-3 w-100">
                                Address: <input type="text" name="address" placeholder="Address" class="form-control w-100">
                            </label>
                            <label class="form-label mb-3 w-100">
                                URL: <input type="url" name="url" placeholder="URL" class="form-control w-100">
                            </label>
                            <label class="form-label mb-3 w-100">
                                Nickname: <input type="text" name="nickname" placeholder="Nickname" class="form-control w-100">
                            </label>
                        </div>

                        <!-- WhatsApp Input Section -->
                        <div id="input-whatsapp" class="input-section" style="display: none;">
                            {% include 'qr/input_phone.html' %}
                            <label class="form-label mb-3 w-100">
                                Message (Optional): <textarea name="message" placeholder="Message" class="form-control w-100" rows="4"></textarea>
                            </label>
                        </div>

                        <!-- Bitcoin Input Section -->
                        <div id="input-bitcoin" class="input-section" style="display: none;">
                            <label class="form-label mb-3 w-100">
                                <span class="text-danger">*</span> Bitcoin Address: <input type="text" name="address" placeholder="Bitcoin Address" class="form-control w-100" required>
                            </label>
                            <label class="form-label mb-3 w-100">
                                <span class="text-danger">*</span> Amount (BTC): <input type="number" step="0.00001" name="amount" placeholder="Amount in BTC" class="form-control w-100">
                            </label>
                            <label class="form-label mb-3 w-100">
                                Label (Optional): <input type="text" name="label" placeholder="Label" class="form-control w-100">
                            </label>
                            <label class="form-label mb-3 w-100">
                                Message (Optional): <textarea name="message" placeholder="Message" class="form-control w-100" rows="4"></textarea>
                            </label>
                        </div>

                        <!-- Submit Button -->
                        <button type="submit">Generate QR Code</button>
                    </form>
                </div>
            </div>

            <!-- QR Result Column -->
            <div class="col-lg-3">
                <div class="card p-4">
                    <h5>Generated QR Code:</h5>
                    <div id="qr-result" style="display: none;">
                        <img id="qr-code" alt="QR Code" src="" class="img-fluid mb-3">
                    </div>
                    <button id="download-png" class="btn btn-primary mb-2" disabled>Download PNG</button>
                    <button id="download-svg" class="btn btn-outline-primary" disabled>Download SVG</button>
                </div>
            </div>
        </div>
    </div>

{#    <script src="{% static 'js/index.js' %}"></script>#}

    <script>
        $(document).ready(function() {
            const $qrTypeRadios = $('input[name="qr_type"]');
            const $inputSections = $('.input-section');
            const $form = $("#qr-form");
            const $qrCodeImg = $("#qr-code");
            const $qrResult = $("#qr-result");
            const $downloadPng = $("#download-png");
            const $downloadSvg = $("#download-svg");

            $(`.country-code-select`).select2({
                theme: `bootstrap-5`,
                placeholder: `Select a country`,
                allowClear: true,
                width: `resolve` // 필요에 따라 너비 조정
            });

            /**
             * Show the relevant input section based on the selected QR code type.
             * Hide all other input sections.
             */
            function showRelevantInput() {
                const selectedType = $('input[name="qr_type"]:checked').val();

                // Hide all input sections
                $inputSections.hide();
                $inputSections.find('input, select, textarea').prop('disabled', true);

                // Show the input section corresponding to the selected QR code type
                const $activeSection = $(`#input-${selectedType}`);
                if ($activeSection.length) {
                    $activeSection.show();
                    $activeSection.find('input, select, textarea').prop('disabled', false);
                    // Set required fields based on selected type
                    $activeSection.find('input[required], textarea[required]').prop('required', true);
                }
            }

            $qrTypeRadios.change(showRelevantInput);
            showRelevantInput();

            // Handle form submission
            $form.submit(function(event) {
                event.preventDefault();
                const selectedType = $('input[name="qr_type"]:checked').val();

                // Generate QR Code 버튼 클릭 이벤트(GA)
                gtag('event', 'generate_qr_code', {
                    'event_category': 'QR Code',
                    'event_label': selectedType,
                    'value': 1
                });

                // Collect form data from the visible input section only
                const $activeSection = $(`#input-${selectedType}`);
                const formDataArray = $activeSection.find('input:not([type="checkbox"]), select, textarea').serializeArray();
                const data = {};
                formDataArray.forEach((item) => {
                    data[item.name] = item.value;
                });

                // Add checkbox values
                $activeSection.find('input[type="checkbox"]').each(function() {
                    data[this.name] = this.checked;
                });

                // country_code와 phone_number가 모두 있으면 phone_number에 country_code를 붙임
                if (data['country_code'] && data['phone_number']) {
                    const countryCode = data['country_code'].replace(/\+/g, '').replace(/\s+/g, '');
                    const phoneNumber = data['phone_number'].replace(/\s+/g, '');
                    data['phone_number'] = countryCode + phoneNumber;
                    delete data['country_code'];
                }

                let url = "";
                switch (selectedType) {
                    case "url":
                        url = "{% url 'qr:qr_url_v1' %}";
                        break;
                    case "email":
                        url = "{% url 'qr:qr_email_v1' %}";
                        break;
                    case "text":
                        url = "{% url 'qr:qr_text_v1' %}";
                        break;
                    case "phone":
                        url = "{% url 'qr:qr_phone_number_v1' %}";
                        break;
                    case "vcard":
                        url = "{% url 'qr:qr_vcard_v1' %}";
                        break;
                    case "wifi":
                        url = "{% url 'qr:qr_wifi_v1' %}";
                        break;
                    case "sms":
                        url = "{% url 'qr:qr_sms_v1' %}";
                        break;
                    case "geo":
                        url = "{% url 'qr:qr_geo_v1' %}";
                        break;
                    case "event":
                        url = "{% url 'qr:qr_event_v1' %}";
                        break;
                    case "mecard":
                        url = "{% url 'qr:qr_mecard_v1' %}";
                        break;
                    case "whatsapp":
                        url = "{% url 'qr:qr_whatsapp_v1' %}";
                        break;
                    case "bitcoin":
                        url = "{% url 'qr:qr_bitcoin_v1' %}";
                        break;
                    default:
                        alert("Invalid QR Code type selected.");
                        return;
                }

                $.ajax({
                    url: url,
                    type: "GET",
                    data: data,
                    xhrFields: {
                        responseType: 'blob'
                    },
                    success: function(blob) {
                        const imageUrl = URL.createObjectURL(blob);
                        $qrCodeImg.attr('src', imageUrl);
                        $qrResult.show();

                        // Enable download buttons
                        $downloadPng.prop('disabled', false);
                        $downloadSvg.prop('disabled', false);
                    },
                    error: function(xhr, status, error) {
                        console.error('Error:', error);
                        alert(`Error generating QR Code: ${error}`);

                        // Disable download buttons on error
                        $downloadPng.prop('disabled', true);
                        $downloadSvg.prop('disabled', true);
                    }
                });
            });

            // Handle PNG download
            $downloadPng.click(function() {
                if ($qrCodeImg.attr('src')) {
                    const link = document.createElement('a');
                    link.href = $qrCodeImg.attr('src');
                    link.download = `qr-code-${Date.now()}.png`;
                    document.body.appendChild(link);
                    link.click();
                    document.body.removeChild(link);

                    // Download PNG 버튼 클릭 이벤트(GA)
                    gtag('event', 'download_png', {
                        'event_category': 'QR Code',
                        'event_label': selectedType,
                        'value': 1
                    });
                }
            });

            // Handle SVG download
            $downloadSvg.click(function() {
                if ($qrCodeImg.attr('src')) {
                    // Convert PNG to SVG using canvas
                    const img = new Image();
                    img.onload = function() {
                        const canvas = document.createElement('canvas');
                        canvas.width = img.width;
                        canvas.height = img.height;
                        const ctx = canvas.getContext('2d');
                        ctx.drawImage(img, 0, 0);

                        // Create SVG
                        const svg = `
                            <svg xmlns="http://www.w3.org/2000/svg" width="${img.width}" height="${img.height}">
                                <image href="${canvas.toDataURL('image/png')}" width="${img.width}" height="${img.height}"/>
                            </svg>
                        `;

                        // Download SVG
                        const blob = new Blob([svg], { type: 'image/svg+xml' });
                        const url = URL.createObjectURL(blob);
                        const link = document.createElement('a');
                        link.href = url;
                        link.download = `qr-code-${Date.now()}.svg`;
                        document.body.appendChild(link);
                        link.click();
                        document.body.removeChild(link);
                        URL.revokeObjectURL(url);

                        // Download SVG 버튼 클릭 이벤트(GA)
                        gtag('event', 'download_svg', {
                            'event_category': 'QR Code',
                            'event_label': selectedType,
                            'value': 1
                        });
                    };
                    img.src = $qrCodeImg.attr('src');
                }
            });
        });
    </script>
{% endblock %}